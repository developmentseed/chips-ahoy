<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="saveas.js"></script>
  </head>
  <body>
    <img src="" />
    <table>
      <tr><td>Index:</td><td class="index"></td></tr>
      <tr><td>Scene:</td><td class="scene"></td></tr>
      <tr><td>Status:</td><td class="status"></td></tr>
    </table>
    <div>
      <label for="switcher">Go to index</label>
      <input class="indexSwitcher" name="switcher" type="number" value="0" onChange="switcher()" />
    </div>
    <div>
      <label for="imagesPath">Images Path</label>
      <input class="imagesPath" name="imagesPath" type="text"  style="width:500px" placeholder="http://api.mapbox.com/v4/digitalglobe.0a8e44ba/{z}/{x}/{y}@2x.png?access_token=..." onChange="updateimagesPath()" />
    </div>
    <div>
      <label for="file">Upload GeoJSON</label>
      <input class="file" name="file" type="file" onChange="fileUpload()" />
    </div>
    <button onClick="save()">Save</button
  </body>
  <script>

  window.imgArray = []
  window.imagesPath = ''
  window.save = function save () {
    var geo = { type: "FeatureCollection", features: window.imgArray }
    var blob = new Blob([JSON.stringify(geo)], {type: "application/json;charset=utf-8"});
    saveAs(blob, 'output.json');
  }

  window.fileUpload = function fileUpload () {
    var file = document.querySelectorAll('.file')[0].files[0]
    var reader = new FileReader()
    reader.onload= () => {
      window.imgArray = JSON.parse(reader.result).features
      updateImage()
    }
    reader.readAsText(file)
  }

  var index = 0

  window.switcher = function switcher (e) {
    index = document.querySelectorAll('.indexSwitcher')[0].value
    updateImage()
  }

   window.updateimagesPath = function updateimagesPath(){
    window.imagesPath = document.querySelectorAll('.imagesPath')[0].value
  }
  function updateImage () {
    var f = window.imgArray[index]
    var [x, y, z] = f.id.match(/\d+/g)
    document.querySelectorAll('img')[0].src = window.imagesPath.replace('{z}',z).replace('{x}',x).replace('{y}',y)
    document.querySelectorAll('.index')[0].innerHTML = index
    document.querySelectorAll('.scene')[0].innerHTML = f.id
    document.querySelectorAll('.status')[0].innerHTML = f.properties.status
    document.querySelectorAll('.indexSwitcher')[0].value = index
    switch (f.properties.status) {
      case 'yes':
        document.querySelectorAll('.status')[0].style.color = 'green'
        break
      case 'no':
        document.querySelectorAll('.status')[0].style.color = 'red'
        break
      default:
        document.querySelectorAll('.status')[0].style.color = 'black'
    }
  }

  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') {
      index++
      updateImage()
    } else if (e.key === 'ArrowLeft') {
      index--
      updateImage()
    } else if (e.key === 'y') {
      window.imgArray[index].properties.status = 'yes'
      index++
      updateImage()
    } else if (e.key === 'n') {
      window.imgArray[index].properties.status = 'no'
      index++
      updateImage()
    }
  })

  </script>
</html>
